# 【Zynq 東方ProjectRPG Game】

## 【TOP】

<details>
    <summary>開発環境</summary></br>
      Create	2021/03/27</br>
      Author	Kimura Kouta</br>
      Board	ArtyZ7-20</br>
      Ubuntu 20.04 LTS</br>
      Vitis20.2</br>
      Vivado20.2</br>
      Vitis_HLS20.2</br>
  </details>
  </br>
  </br>

## 【ブログ】
色々やっているブログ → (https://aki-kimura.hatenablog.com/)</br>
</br>
</br>


## 【コンセプト】
最終目標は、大規模イベントの **`東方Project秋季例大祭`** に出店し販売すること。(主人公が秋姉妹なので)</br>
オリジナルのハードウェア、ソフトウェアを製作し、エンドユーザのハートを掴む。</br>
**`途中で投げ出さずに最後までやり抜くこと。`**</br>
</br>
</br>

## 【仕様】

<details>
  <summary>1. 映像描画</summary></br>
  
  FPGAを使用したHDMI出力にする。</br>
  TFT_LCDを使用した携帯機を考えたが個人では値段が高価なため断念。</br>
  素材は配布可能なものを使用。</br>
    </br>
</details>

<details>
  <summary>2. データ関連</summary></br>
  
  SDカード、もしくはUSB、もしくはQSPIフラッシュメモリを使用。</br>
  ライセンスの仕様による。</br>
  DDRメモリは現状512MByteで足りそうではあるため同じで行く予定。</br>
  </br>
</details>

<details>
  <summary>3. 操作性</summary></br>
  
  6つのタクトスイッチを使用、上下左右ABボタン。</br>
  当初はカメラモジュールとセンサを用いてモーションキャプチャーにしようとした。</br>
  非接触＆運動不足解消になると思ったが、個人では値段が高くなるため断念。</br>
  </br>
</details>

<details>
  <summary>4. 音源関連</summary></br>
  
  I2Sを使用。</br>
  48khzの音源データを使用しアンプ回路を組んで出力とする。</br>
  デジタルフィルタで音源の加工を行い、アンプ回路の規模を小さくするようにする。</br>
  音源はフリーのものを使用。</br>
  </br>
</details>

<details>
  <summary>5. 基板</summary></br>

  BOM数、BOMコストを抑えるため、**`必要最低限の部品で製作する。`**</br>
  携帯機ではなくなったためある程度の大きさは許容する。</br>
  最低でも4層基板になるため、受注時に予め値段を調べておき最も安く作りやすい大きさで製作する。</br>
  - 評価基板にあるけどいらないもの</br>
    1. イーサネットコントローラ</br>
    2. USBデバッグ関連の回路</br>
    </br>
  - 評価基板を真似るべきもの</br>
    1. Zynqと電源回りの回路</br>
    2. HDMIの出力回路</br>
    3. スイッチ関連</br>
    4. USB書き込み回路</br>
    5. SDカード回路</br>
    6. FPGAの回路保存に使用するQSPIの回路</br>
    </br>
  - 追加しなければいけないもの</br>
    1. オーディオ回路</br>
    2. SDカードを読み込み専用にするならばセーブデータ書き込み用のEEPROM</br>
  </br>
</details>

<details>
  <summary>6. 筐体</summary></br>
  適当な業者に発注する。</br>
  二次元的な加工を施す。</br>
</br>
</details>
</br>
</br>

## 【ディレクトリツリー】
ファイル名 | 詳細
-|-
calc | プロジェクト全体で使用することになる、ビット演算やよく利用する計算処理のマクロと関数を管理する。</br>マクロを使用する場合は複雑な処理は行わないようにする
debug | エラー時のデバッグ出力関数を管理する
event | システムを動作させる全てのイベント処理関数を管理する</br>キャラクターが動いた、当たり判定があった、メニューを開いたなど様々なアクションはイベントとみなす
hardware | ハードウェアを操作する関数を管理する。</br>PL部の呼び出し関数や外部に信号を出力、または外部から信号を入力する時はハード操作とみなす
minigame | ミニゲームの動作関数を管理する
opening | オープニング画面の描画と起動時のデータ読み込み関数を管理する
story | ストーリー進行の関数を管理する。</br>描画の更新・イベントの更新・状態の処理を行う
wrapper | main関数とシステムを動作させるRamの作業領域と定数マクロを管理する。</br>データ数が少なく頻繁にアクセスし静的に保持しておく必要がある変数は内部Ramとして保持する。</br>頻繁にアクセスするがデータ数が大きく内部に保持しておけないデータは外部Ramに保存する。</br>データはラッパー構造体としてシステム全体で共有できる形にする


## 【履歴・所感】
<!-- 9 month --------------------------------------->
<details>
<summary>2021/09</summary></br>
  「所感」</br>
  見落としが無ければ、残るはイベントフラグの処理部分まで進んだと思う。</br>
  RPGは色んなフラグが入り乱れあって成立しているため、一番時間が掛かりそうな所だったので後回しにしていた。</br>
  多分、通常のゲームではスクリプトファイルを読み込んだりしてデータ処理をすると思うのだが、</br>
  Zynqでそこをどうやって処理するか考え中である。</br>
  ただここをクリアすれば、かなり良い感じになるので頑張るしかない。</br>
  </br>
</details>

<!-- 8 month --------------------------------------->
<details>
<summary>2021/08</summary></br>
  「所感」</br>
  RPGの醍醐味である戦闘処理を実装した。</br>
  毎度のことながら自分に実装できるか不安はあったけれども、遊べるレベルまでは到達できたと思う。</br>
  ATBシステム風なものを実装したのだが、自分で一から書いただけあって、思い通りにキャラクターが戦っているだけでも面白い。</br>
  こういった動く機能を実装できるとモチベーションが上がってくる。</br>
  </br>
</details>

<!-- 7 month --------------------------------------->
<details>
<summary>2021/07</summary></br>
  「所感」</br>
  季節が夏ということで、ジメジメしていてモチベーションが上がりにくい月だった。</br>
  データ構造・データの持ち方をリファクタリングして、SDカードのファイルを読み込んでDRAMに保存し、その保存データを使用する形に変更した。</br>
  これができるようになると、大きいデータを持てるようになるのだが、反面アドレスに直接アクセスする機会が増えるためバグが起こりやすくなる。</br>
  実際今月はバグと対話している時間が長かったため、なるべくアクセス部分を自動化するソースコードに変更しようと思う。</br>
  今苦労しておけば、後々楽ができるはず。</br>
  </br>
</details>

<!-- 6 month --------------------------------------->
<details>
<summary>2021/06</summary></br>
  「所感」</br>
  RPGではなく、まずは一画面で遊べるミニゲームを作ることとした。</br>
  そこである程度のものが作れればノウハウが得られると考えたためである。</br>
  pixelの操作に慣れるため縦横無尽に動き回る処理を行った結果、割と楽しいものが出来上がった気がする。</br>
  使わないのはもったいないため、ストーリー進行上のミニゲームとして実装しようと思う。</br>
  </br>
</details>

<!-- 5 month --------------------------------------->
<details>
<summary>2021/05</summary></br>
  「所感」</br>
  結構進捗が良い感じなような気がする。</br>
  とりあえずPL部での処理は置いておいて、慣れているC言語で画面描画やDRAM操作の確認をしていた。</br>
  実際に動いて嬉しく思ったが、やはり純粋なソフトでは画面データの更新処理は大変なようなのでPL部に処理を移行することとした。</br>
  VivadoでのAXIを使用するIPの作り方が良くわからなかったので、Vitis-HLSの高位合成にチャレンジしてみた。</br>
  テストにテストを重ね、紆余曲折を得て、ようやくまともに動くソースコードができたので良しとする。</br>
  ただ、簡単な描画ができただけでゲームっぽさは全く感じられないので、早く次のステージに進みたい。</br>
  </br>
</details>

<!-- 4 month --------------------------------------->
<details>
<summary>2021/04</summary></br>
  「所感」</br>
  プロジェクトの開始。</br>
  実際に作業を始めると沢山の課題に直面することとなった。</br>
  画像や音源の素材の作成、Zynqの環境構築、ArtyZ7-20の使用方法などなど・・・。</br>
  ソースコード以外の部分で凄く時間がかかりそうである。</br>
  何処から手を付けていいか混乱してしまったので、一度作業内容をガントチャートにまとめることにした。</br>
  </br>
</details>

<!-- 3 month --------------------------------------->
<details>
<summary>2021/03</summary></br>
  「所感」</br>
  プロットの作成、仕様決定。</br>
  今日からプロジェクトを始める訳だが、多分行き当たりばったり上手くいかないことが大半だと思う。</br>
  休日の時間を利用して何処まで進めることができるか、自分に期待する。</br>
  休日でもデバッグ作業は大変だと思うけど頑張ってほしい。</br>
  </br>
</details>